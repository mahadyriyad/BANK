{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Withdraw Money - NeoVault Bank{% endblock %}

{% block dashboard_content %}
<div class="page-header animate-slide-up">
    <h1><i class="fas fa-hand-holding-usd me-2"></i>Withdraw Money</h1>
    <p class="text-muted">Withdraw funds from your account securely</p>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="operation-card animate-fade-in">
            <h3 class="mb-4">üí∏ Make a Withdrawal</h3>
            
            <form id="withdrawForm">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label for="accountSelect" class="form-label">Select Account</label>
                    <select class="form-select" id="accountSelect" required>
                        <option value="">Choose account...</option>
                        {% for account in user_accounts %}
                        <option value="{{ account.id }}" data-balance="{{ account.balance }}">
                            {{ account.get_account_type_display }} - {{ account.account_number }} (Balance: ‡ß≥{{ account.balance|floatformat:2 }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="amount" class="form-label">Amount</label>
                    <div class="input-group">
                        <span class="input-group-text">‡ß≥</span>
                        <input type="number" class="form-control" id="amount" 
                               placeholder="0.00" min="100" step="0.01" required>
                    </div>
                    <div class="form-text">Minimum withdrawal: ‡ß≥100.00</div>
                </div>
                
                <div class="mb-4">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" rows="3" 
                              placeholder="Add a note for this withdrawal (optional)"></textarea>
                </div>
                
                <div class="mb-4">
                    <label class="form-label">Withdrawal Method</label>
                    <div class="withdrawal-methods">
                        <div class="method-option active" data-method="atm">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>ATM Withdrawal</span>
                        </div>
                        <div class="method-option" data-method="bank-transfer">
                            <i class="fas fa-university"></i>
                            <span>Bank Transfer</span>
                        </div>
                        <div class="method-option" data-method="check">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span>Check</span>
                        </div>
                        <div class="method-option" data-method="branch">
                            <i class="fas fa-building"></i>
                            <span>Branch Withdrawal</span>
                        </div>
                    </div>
                </div>
                
                <!-- ATM Withdrawal Details -->
                <div class="method-details active" id="atm-details">
                    <h5 class="mb-3">üèß ATM Withdrawal</h5>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        You can withdraw cash from any of our 500+ ATMs nationwide. Maximum daily limit: ‡ß≥50,000
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select ATM Location</label>
                        <select class="form-select">
                            <option>Nearest ATM to you (2.1 km)</option>
                            <option>Main Branch ATM (5.3 km)</option>
                            <option>Downtown ATM (3.7 km)</option>
                            <option>Shopping Mall ATM (4.2 km)</option>
                        </select>
                    </div>
                    <div class="atm-locations">
                        <h6>Nearby ATMs:</h6>
                        <div class="location-item">
                            <i class="fas fa-map-marker-alt text-danger"></i>
                            <div>
                                <strong>Gulshan Branch ATM</strong>
                                <small>2.1 km away ‚Ä¢ 24/7</small>
                            </div>
                        </div>
                        <div class="location-item">
                            <i class="fas fa-map-marker-alt text-danger"></i>
                            <div>
                                <strong>Banani ATM Center</strong>
                                <small>3.5 km away ‚Ä¢ 24/7</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bank Transfer Details -->
                <div class="method-details" id="bank-transfer-details">
                    <h5 class="mb-3">üè¶ Transfer to Another Bank</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Bank Name</label>
                            <select class="form-select">
                                <option value="">Select bank...</option>
                                <option value="dutch">Dutch-Bangla Bank</option>
                                <option value="brac">BRAC Bank</option>
                                <option value="city">City Bank</option>
                                <option value="eastern">Eastern Bank</option>
                                <option value="other">Other Bank</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Account Number</label>
                            <input type="text" class="form-control" placeholder="Enter account number">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Account Holder Name</label>
                            <input type="text" class="form-control" placeholder="Enter account holder name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Routing Number</label>
                            <input type="text" class="form-control" placeholder="Enter routing number">
                        </div>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-clock me-2"></i>
                        Transfers typically take 1-2 business days
                    </div>
                </div>
                
                <!-- Check Details -->
                <div class="method-details" id="check-details">
                    <h5 class="mb-3">üìÑ Check Request</h5>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Checks will be mailed to your registered address within 3-5 business days
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payable To</label>
                        <input type="text" class="form-control" value="{{ user.get_full_name }}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Delivery Address</label>
                        <textarea class="form-control" rows="3" readonly>{{ user.profile.address|default:"Please update your address in profile settings" }}</textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="expressDelivery">
                        <label class="form-check-label" for="expressDelivery">
                            Express Delivery (+‡ß≥100)
                        </label>
                    </div>
                </div>
                
                <!-- Branch Withdrawal Details -->
                <div class="method-details" id="branch-details">
                    <h5 class="mb-3">üèõÔ∏è Branch Withdrawal</h5>
                    <div class="alert alert-success">
                        <i class="fas fa-info-circle me-2"></i>
                        Visit any branch with your ID card to withdraw cash
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select Branch</label>
                        <select class="form-select">
                            <option value="">Choose branch...</option>
                            <option value="dhaka">Dhaka Main Branch</option>
                            <option value="chittagong">Chittagong Branch</option>
                            <option value="sylhet">Sylhet Branch</option>
                            <option value="khulna">Khulna Branch</option>
                        </select>
                    </div>
                    <div class="branch-info">
                        <h6>Branch Hours:</h6>
                        <div class="schedule">
                            <div>Sunday - Thursday: 9:00 AM - 5:00 PM</div>
                            <div>Friday: 9:00 AM - 12:30 PM, 2:30 PM - 5:00 PM</div>
                            <div>Saturday: Closed</div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-paper-plane me-2"></i>Process Withdrawal
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Withdrawal Summary -->
        <div class="summary-card animate-fade-in">
            <h4 class="mb-4">üíµ Withdrawal Summary</h4>
            
            <div class="summary-item">
                <span>Selected Account:</span>
                <strong id="selectedAccount">-</strong>
            </div>
            
            <div class="summary-item">
                <span>Current Balance:</span>
                <strong id="currentBalance">-</strong>
            </div>
            
            <div class="summary-item">
                <span>Withdrawal Amount:</span>
                <strong id="withdrawalAmount">‡ß≥0.00</strong>
            </div>
            
            <div class="summary-item">
                <span>Service Fee:</span>
                <strong id="serviceFee">‡ß≥0.00</strong>
            </div>
            
            <div class="summary-item">
                <span>New Balance:</span>
                <strong id="newBalance">-</strong>
            </div>
            
            <hr>
            
            <div class="summary-item total">
                <span>Total to Withdraw:</span>
                <strong id="totalAmount">‡ß≥0.00</strong>
            </div>
            
            <div class="balance-warning alert alert-warning mt-3" id="balanceWarning" style="display: none;">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="warningMessage"></span>
            </div>
        </div>
        
        <!-- Quick Tips -->
        <div class="tips-card animate-fade-in">
            <h5><i class="fas fa-lightbulb me-2"></i>üí° Withdrawal Limits</h5>
            <ul class="tips-list">
                <li>Daily ATM limit: ‡ß≥50,000</li>
                <li>Daily transfer limit: ‡ß≥100,000</li>
                <li>Check requests: No limit</li>
                <li>Branch withdrawals: No limit with ID</li>
                <li>Large withdrawals require advance notice</li>
            </ul>
        </div>
        
        <!-- Recent Withdrawals -->
        <div class="recent-card animate-fade-in">
            <h5>üïê Recent Withdrawals</h5>
            <div class="recent-list">
                {% for transaction in recent_withdrawals %}
                <div class="recent-item">
                    <div class="recent-info">
                        <strong>‡ß≥{{ transaction.amount|floatformat:2 }}</strong>
                        <small>{{ transaction.timestamp|date:"M d" }}</small>
                    </div>
                    <span class="status completed">Completed</span>
                </div>
                {% empty %}
                <div class="empty-state-small">
                    <i class="fas fa-history text-muted"></i>
                    <p class="text-muted mb-0">No recent withdrawals</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<button onclick="testWithdraw()" class="btn btn-warning mt-3">
    <i class="fas fa-bug me-2"></i>Test Withdraw API
</button>

<!-- Processing Modal -->
<div class="modal fade" id="processingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="processing-spinner">
                    <i class="fas fa-sync fa-spin"></i>
                </div>
                <h3 class="mt-4 mb-3">Processing Withdrawal</h3>
                <p class="text-muted mb-4" id="processingMessage">Please wait while we process your transaction...</p>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Insufficient Funds Modal -->
<div class="modal fade" id="insufficientFundsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="error-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 class="mt-4 mb-3">Insufficient Funds</h3>
                <p class="text-muted mb-4">You don't have enough balance to complete this withdrawal.</p>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Utility function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Notification function
function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.custom-notification');
    existingNotifications.forEach(notification => notification.remove());

    // Create new notification
    const notification = document.createElement('div');
    notification.className = `custom-notification alert alert-${type} alert-dismissible fade show`;
    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${getNotificationIcon(type)} me-2"></i>
            <span>${message}</span>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);

    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function getNotificationIcon(type) {
    const icons = {
        success: 'check-circle',
        error: 'exclamation-circle',
        warning: 'exclamation-triangle',
        info: 'info-circle'
    };
    return icons[type] || 'info-circle';
}

// Main withdraw functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('Withdraw page loaded');
    
    const withdrawForm = document.getElementById('withdrawForm');
    const accountSelect = document.getElementById('accountSelect');
    const amountInput = document.getElementById('amount');
    
    if (withdrawForm) {
        console.log('Withdraw form found');
        
        withdrawForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Withdraw form submitted');
            
            // Get form values
            const accountId = accountSelect.value;
            const amount = amountInput.value;
            const description = document.getElementById('description').value || 'Cash Withdrawal';
            
            console.log('Form values:', { accountId, amount, description });
            
            // Validation
            if (!accountId) {
                showNotification('Please select an account', 'error');
                return;
            }
            
            if (!amount || parseFloat(amount) < 100) {
                showNotification('Minimum withdrawal amount is ‡ß≥100.00', 'error');
                return;
            }
            
            // Get selected account balance
            const selectedOption = accountSelect.options[accountSelect.selectedIndex];
            const accountBalance = parseFloat(selectedOption.getAttribute('data-balance'));
            
            if (parseFloat(amount) > accountBalance) {
                showNotification('Insufficient funds in selected account', 'error');
                return;
            }
            
            // Show loading state
            const submitBtn = withdrawForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div> Processing...';
            submitBtn.disabled = true;
            
            try {
                // Prepare request data
                const requestData = {
                    account_id: parseInt(accountId),
                    amount: parseFloat(amount),
                    description: description
                };
                
                console.log('Sending withdraw request:', requestData);
                
                // Make API call
                const response = await fetch('/withdraw_api/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                console.log('Withdraw API response:', data);
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    
                    // Reset form
                    withdrawForm.reset();
                    
                    // Show success modal
                    const successModal = document.getElementById('successModal');
                    if (successModal) {
                        // Update modal content
                        const successMessage = document.getElementById('successMessage');
                        const successAmount = document.getElementById('successAmount');
                        
                        if (successMessage) successMessage.textContent = data.message;
                        if (successAmount) successAmount.textContent = `‡ß≥${parseFloat(amount).toFixed(2)}`;
                        
                        const modal = new bootstrap.Modal(successModal);
                        modal.show();
                    }
                    
                    // Update account balance in dropdown
                    if (data.new_balance !== undefined) {
                        selectedOption.setAttribute('data-balance', data.new_balance);
                        selectedOption.textContent = selectedOption.textContent.replace(
                            /\(Balance: ‡ß≥[0-9.,]+\)/,
                            `(Balance: ‡ß≥${data.new_balance.toFixed(2)})`
                        );
                    }
                    
                } else {
                    showNotification(data.message || 'Withdrawal failed', 'error');
                }
                
            } catch (error) {
                console.error('Withdraw error:', error);
                showNotification('Network error occurred. Please try again.', 'error');
            } finally {
                // Restore button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
        
    } else {
        console.error('Withdraw form not found!');
    }
    
    // Real-time balance validation
    if (amountInput && accountSelect) {
        amountInput.addEventListener('input', function() {
            const amount = parseFloat(this.value);
            const selectedOption = accountSelect.options[accountSelect.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                const accountBalance = parseFloat(selectedOption.getAttribute('data-balance'));
                
                if (amount > accountBalance) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            }
        });
        
        accountSelect.addEventListener('change', function() {
            amountInput.classList.remove('is-invalid');
        });
    }
});

// Test function - add this button to your page for debugging
function testWithdraw() {
    console.log('Testing withdraw function...');
    
    const testData = {
        account_id: 1, // Change to your actual account ID
        amount: 100,
        description: 'Test withdrawal'
    };
    
    console.log('Test data:', testData);
    
    fetch('/withdraw_api/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(testData)
    })
    .then(response => response.json())
    .then(data => console.log('Test response:', data))
    .catch(error => console.error('Test error:', error));
}
</script>
{% endblock %}