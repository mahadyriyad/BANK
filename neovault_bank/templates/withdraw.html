{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Withdraw Money - NeoVault Bank{% endblock %}

{% block dashboard_content %}
<div class="page-header animate-slide-up">
    <h1><i class="fas fa-hand-holding-usd me-2"></i>Withdraw Money</h1>
    <p class="text-muted">Withdraw funds from your account securely</p>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="operation-card animate-fade-in">
            <h3 class="mb-4">üí∏ Make a Withdrawal</h3>
            
            <form id="withdrawForm">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label for="accountSelect" class="form-label">Select Account</label>
                    <select class="form-select" id="accountSelect" required>
                        <option value="">Choose account...</option>
                        {% for account in user_accounts %}
                        <option value="{{ account.id }}" data-balance="{{ account.balance }}">
                            {{ account.get_account_type_display }} - {{ account.account_number }} (Balance: ‡ß≥{{ account.balance|floatformat:2 }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="amount" class="form-label">Amount</label>
                    <div class="input-group">
                        <span class="input-group-text">‡ß≥</span>
                        <input type="number" class="form-control" id="amount" 
                               placeholder="0.00" min="100" step="0.01" required>
                    </div>
                    <div class="form-text">Minimum withdrawal: ‡ß≥100.00</div>
                </div>
                
                <div class="mb-4">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" rows="3" 
                              placeholder="Add a note for this withdrawal (optional)"></textarea>
                </div>
                
                <div class="mb-4">
                    <label class="form-label">Withdrawal Method</label>
                    <div class="withdrawal-methods">
                        <div class="method-option active" data-method="atm">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>ATM Withdrawal</span>
                        </div>
                        <div class="method-option" data-method="bank-transfer">
                            <i class="fas fa-university"></i>
                            <span>Bank Transfer</span>
                        </div>
                        <div class="method-option" data-method="check">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span>Check</span>
                        </div>
                        <div class="method-option" data-method="branch">
                            <i class="fas fa-building"></i>
                            <span>Branch Withdrawal</span>
                        </div>
                    </div>
                </div>
                
                <!-- ATM Withdrawal Details -->
                <div class="method-details active" id="atm-details">
                    <h5 class="mb-3">üèß ATM Withdrawal</h5>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        You can withdraw cash from any of our 500+ ATMs nationwide. Maximum daily limit: ‡ß≥50,000
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select ATM Location</label>
                        <select class="form-select">
                            <option>Nearest ATM to you (2.1 km)</option>
                            <option>Main Branch ATM (5.3 km)</option>
                            <option>Downtown ATM (3.7 km)</option>
                            <option>Shopping Mall ATM (4.2 km)</option>
                        </select>
                    </div>
                    <div class="atm-locations">
                        <h6>Nearby ATMs:</h6>
                        <div class="location-item">
                            <i class="fas fa-map-marker-alt text-danger"></i>
                            <div>
                                <strong>Gulshan Branch ATM</strong>
                                <small>2.1 km away ‚Ä¢ 24/7</small>
                            </div>
                        </div>
                        <div class="location-item">
                            <i class="fas fa-map-marker-alt text-danger"></i>
                            <div>
                                <strong>Banani ATM Center</strong>
                                <small>3.5 km away ‚Ä¢ 24/7</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bank Transfer Details -->
                <div class="method-details" id="bank-transfer-details">
                    <h5 class="mb-3">üè¶ Transfer to Another Bank</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Bank Name</label>
                            <select class="form-select">
                                <option value="">Select bank...</option>
                                <option value="dutch">Dutch-Bangla Bank</option>
                                <option value="brac">BRAC Bank</option>
                                <option value="city">City Bank</option>
                                <option value="eastern">Eastern Bank</option>
                                <option value="other">Other Bank</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Account Number</label>
                            <input type="text" class="form-control" placeholder="Enter account number">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Account Holder Name</label>
                            <input type="text" class="form-control" placeholder="Enter account holder name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Routing Number</label>
                            <input type="text" class="form-control" placeholder="Enter routing number">
                        </div>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-clock me-2"></i>
                        Transfers typically take 1-2 business days
                    </div>
                </div>
                
                <!-- Check Details -->
                <div class="method-details" id="check-details">
                    <h5 class="mb-3">üìÑ Check Request</h5>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Checks will be mailed to your registered address within 3-5 business days
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payable To</label>
                        <input type="text" class="form-control" value="{{ user.get_full_name }}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Delivery Address</label>
                        <textarea class="form-control" rows="3" readonly>{{ user.profile.address|default:"Please update your address in profile settings" }}</textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="expressDelivery">
                        <label class="form-check-label" for="expressDelivery">
                            Express Delivery (+‡ß≥100)
                        </label>
                    </div>
                </div>
                
                <!-- Branch Withdrawal Details -->
                <div class="method-details" id="branch-details">
                    <h5 class="mb-3">üèõÔ∏è Branch Withdrawal</h5>
                    <div class="alert alert-success">
                        <i class="fas fa-info-circle me-2"></i>
                        Visit any branch with your ID card to withdraw cash
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select Branch</label>
                        <select class="form-select">
                            <option value="">Choose branch...</option>
                            <option value="dhaka">Dhaka Main Branch</option>
                            <option value="chittagong">Chittagong Branch</option>
                            <option value="sylhet">Sylhet Branch</option>
                            <option value="khulna">Khulna Branch</option>
                        </select>
                    </div>
                    <div class="branch-info">
                        <h6>Branch Hours:</h6>
                        <div class="schedule">
                            <div>Sunday - Thursday: 9:00 AM - 5:00 PM</div>
                            <div>Friday: 9:00 AM - 12:30 PM, 2:30 PM - 5:00 PM</div>
                            <div>Saturday: Closed</div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-paper-plane me-2"></i>Process Withdrawal
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Withdrawal Summary -->
        <div class="summary-card animate-fade-in">
            <h4 class="mb-4">üíµ Withdrawal Summary</h4>
            
            <div class="summary-item">
                <span>Selected Account:</span>
                <strong id="selectedAccount">-</strong>
            </div>
            
            <div class="summary-item">
                <span>Current Balance:</span>
                <strong id="currentBalance">-</strong>
            </div>
            
            <div class="summary-item">
                <span>Withdrawal Amount:</span>
                <strong id="withdrawalAmount">‡ß≥0.00</strong>
            </div>
            
            <div class="summary-item">
                <span>Service Fee:</span>
                <strong id="serviceFee">‡ß≥0.00</strong>
            </div>
            
            <div class="summary-item">
                <span>New Balance:</span>
                <strong id="newBalance">-</strong>
            </div>
            
            <hr>
            
            <div class="summary-item total">
                <span>Total to Withdraw:</span>
                <strong id="totalAmount">‡ß≥0.00</strong>
            </div>
            
            <div class="balance-warning alert alert-warning mt-3" id="balanceWarning" style="display: none;">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="warningMessage"></span>
            </div>
        </div>
        
        <!-- Quick Tips -->
        <div class="tips-card animate-fade-in">
            <h5><i class="fas fa-lightbulb me-2"></i>üí° Withdrawal Limits</h5>
            <ul class="tips-list">
                <li>Daily ATM limit: ‡ß≥50,000</li>
                <li>Daily transfer limit: ‡ß≥100,000</li>
                <li>Check requests: No limit</li>
                <li>Branch withdrawals: No limit with ID</li>
                <li>Large withdrawals require advance notice</li>
            </ul>
        </div>
        
        <!-- Recent Withdrawals -->
        <div class="recent-card animate-fade-in">
            <h5>üïê Recent Withdrawals</h5>
            <div class="recent-list">
                {% for transaction in recent_withdrawals %}
                <div class="recent-item">
                    <div class="recent-info">
                        <strong>‡ß≥{{ transaction.amount|floatformat:2 }}</strong>
                        <small>{{ transaction.timestamp|date:"M d" }}</small>
                    </div>
                    <span class="status completed">Completed</span>
                </div>
                {% empty %}
                <div class="empty-state-small">
                    <i class="fas fa-history text-muted"></i>
                    <p class="text-muted mb-0">No recent withdrawals</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 class="mt-4 mb-3">üéâ Withdrawal Successful!</h3>
                <p class="text-muted mb-4" id="successMessage">Your withdrawal has been processed successfully.</p>
                <div class="withdrawal-details mb-4">
                    <div class="detail-row">
                        <span>Amount:</span>
                        <strong id="successAmount"></strong>
                    </div>
                    <div class="detail-row">
                        <span>Method:</span>
                        <strong id="successMethod"></strong>
                    </div>
                    <div class="detail-row">
                        <span>New Balance:</span>
                        <strong id="successBalance"></strong>
                    </div>
                    <div class="detail-row">
                        <span>Reference:</span>
                        <strong id="successReference"></strong>
                    </div>
                </div>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Continue</button>
                    <button type="button" class="btn btn-outline-primary print-receipt" id="printWithdrawalReceipt">
                        <i class="fas fa-print me-2"></i>Print Receipt
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Processing Modal -->
<div class="modal fade" id="processingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="processing-spinner">
                    <i class="fas fa-sync fa-spin"></i>
                </div>
                <h3 class="mt-4 mb-3">Processing Withdrawal</h3>
                <p class="text-muted mb-4" id="processingMessage">Please wait while we process your transaction...</p>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Insufficient Funds Modal -->
<div class="modal fade" id="insufficientFundsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="error-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 class="mt-4 mb-3">Insufficient Funds</h3>
                <p class="text-muted mb-4">You don't have enough balance to complete this withdrawal.</p>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const accountSelect = document.getElementById('accountSelect');
    const amountInput = document.getElementById('amount');
    const withdrawForm = document.getElementById('withdrawForm');
    const methodOptions = document.querySelectorAll('.method-option');
    
    let currentMethod = 'atm';
    let serviceFee = 0;
    
    // Update summary when account or amount changes
    accountSelect.addEventListener('change', updateSummary);
    amountInput.addEventListener('input', updateSummary);
    
    // Withdrawal method selection
    methodOptions.forEach(option => {
        option.addEventListener('click', function() {
            methodOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            
            // Show corresponding method details
            currentMethod = this.getAttribute('data-method');
            document.querySelectorAll('.method-details').forEach(detail => {
                detail.classList.remove('active');
            });
            document.getElementById(`${currentMethod}-details`).classList.add('active');
            
            // Update service fee based on method
            updateServiceFee();
            updateSummary();
        });
    });
    
    function updateServiceFee() {
        switch(currentMethod) {
            case 'atm':
                serviceFee = 15;
                break;
            case 'bank-transfer':
                serviceFee = 25;
                break;
            case 'check':
                serviceFee = 50;
                break;
            case 'branch':
                serviceFee = 0;
                break;
        }
        
        // Add express delivery fee for checks
        if (currentMethod === 'check') {
            const expressCheckbox = document.getElementById('expressDelivery');
            if (expressCheckbox && expressCheckbox.checked) {
                serviceFee += 100;
            }
        }
    }
    
    function updateSummary() {
        const selectedOption = accountSelect.options[accountSelect.selectedIndex];
        const currentBalance = selectedOption ? parseFloat(selectedOption.getAttribute('data-balance')) : 0;
        const withdrawalAmount = parseFloat(amountInput.value) || 0;
        const totalAmount = withdrawalAmount + serviceFee;
        
        document.getElementById('selectedAccount').textContent = 
            selectedOption ? selectedOption.text.split('(')[0] : '-';
        document.getElementById('currentBalance').textContent = 
            currentBalance ? `‡ß≥${currentBalance.toFixed(2)}` : '-';
        document.getElementById('withdrawalAmount').textContent = `‡ß≥${withdrawalAmount.toFixed(2)}`;
        document.getElementById('serviceFee').textContent = `‡ß≥${serviceFee.toFixed(2)}`;
        document.getElementById('totalAmount').textContent = `‡ß≥${totalAmount.toFixed(2)}`;
        
        const balanceWarning = document.getElementById('balanceWarning');
        const warningMessage = document.getElementById('warningMessage');
        
        if (currentBalance) {
            const newBalance = currentBalance - totalAmount;
            document.getElementById('newBalance').textContent = `‡ß≥${newBalance.toFixed(2)}`;
            
            // Show warnings
            if (newBalance < 0) {
                balanceWarning.style.display = 'block';
                warningMessage.textContent = 'Insufficient funds for this withdrawal';
                balanceWarning.className = 'alert alert-danger mt-3';
            } else if (newBalance < 1000) {
                balanceWarning.style.display = 'block';
                warningMessage.textContent = 'Low balance after withdrawal';
                balanceWarning.className = 'alert alert-warning mt-3';
            } else {
                balanceWarning.style.display = 'none';
            }
        }
    }
    
    // Express delivery fee for checks
    const expressCheckbox = document.getElementById('expressDelivery');
    if (expressCheckbox) {
        expressCheckbox.addEventListener('change', function() {
            updateServiceFee();
            updateSummary();
        });
    }
    
    // Form submission
    withdrawForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const selectedOption = accountSelect.options[accountSelect.selectedIndex];
        const currentBalance = selectedOption ? parseFloat(selectedOption.getAttribute('data-balance')) : 0;
        const withdrawalAmount = parseFloat(amountInput.value) || 0;
        const totalAmount = withdrawalAmount + serviceFee;
        
        // Validation
        if (!selectedOption || !selectedOption.value) {
            showNotification('Please select an account', 'error');
            return;
        }
        
        if (withdrawalAmount < 100) {
            showNotification('Minimum withdrawal amount is ‡ß≥100.00', 'error');
            return;
        }
        
        if (currentBalance < totalAmount) {
            const insufficientModal = new bootstrap.Modal(document.getElementById('insufficientFundsModal'));
            insufficientModal.show();
            return;
        }
        
        // Show processing modal with appropriate message
        const processingModal = new bootstrap.Modal(document.getElementById('processingModal'));
        const processingMessage = document.getElementById('processingMessage');
        
        switch(currentMethod) {
            case 'atm':
                processingMessage.textContent = 'Processing ATM withdrawal request...';
                break;
            case 'bank-transfer':
                processingMessage.textContent = 'Processing bank transfer...';
                break;
            case 'check':
                processingMessage.textContent = 'Processing check request...';
                break;
            case 'branch':
                processingMessage.textContent = 'Processing branch withdrawal...';
                break;
        }
        
        processingModal.show();
        
        // Simulate API call
        setTimeout(() => {
            processingModal.hide();
            
            // Show success modal
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            const successMessage = document.getElementById('successMessage');
            const transactionId = 'WD' + Date.now();
            
            document.getElementById('successAmount').textContent = `‡ß≥${withdrawalAmount.toFixed(2)}`;
            document.getElementById('successMethod').textContent = currentMethod.charAt(0).toUpperCase() + currentMethod.slice(1);
            document.getElementById('successBalance').textContent = `‡ß≥${(currentBalance - totalAmount).toFixed(2)}`;
            document.getElementById('successReference').textContent = transactionId;
            
            // Set success message based on method
            switch(currentMethod) {
                case 'atm':
                    successMessage.textContent = 'ATM withdrawal code has been sent to your mobile.';
                    break;
                case 'bank-transfer':
                    successMessage.textContent = 'Bank transfer has been initiated. It will take 1-2 business days.';
                    break;
                case 'check':
                    successMessage.textContent = 'Check will be delivered to your address within 3-5 business days.';
                    break;
                case 'branch':
                    successMessage.textContent = 'Visit the branch with your ID card to collect the cash.';
                    break;
            }
            
            // Update print button
            document.getElementById('printWithdrawalReceipt').setAttribute('data-transaction-id', transactionId);
            document.getElementById('printWithdrawalReceipt').setAttribute('data-amount', withdrawalAmount.toFixed(2));
            document.getElementById('printWithdrawalReceipt').setAttribute('data-method', currentMethod);
            
            successModal.show();
            
            // Reset form
            withdrawForm.reset();
            updateSummary();
        }, 3000);
    });
    
    // Print receipt functionality
    document.getElementById('printWithdrawalReceipt').addEventListener('click', function() {
        const transactionData = {
            id: this.getAttribute('data-transaction-id'),
            type: 'Withdrawal',
            amount: this.getAttribute('data-amount'),
            date: new Date().toLocaleString(),
            fromAccount: document.getElementById('selectedAccount').textContent,
            toAccount: this.getAttribute('data-method').charAt(0).toUpperCase() + this.getAttribute('data-method').slice(1),
            description: document.getElementById('description').value || 'Cash Withdrawal',
            method: currentMethod,
            fee: serviceFee
        };
        
        if (window.PrintUtils) {
            window.PrintUtils.printTransactionReceipt(transactionData);
        } else {
            showNotification('Print functionality is not available', 'warning');
        }
    });
    
    // Initialize
    updateServiceFee();
    updateSummary();
});
</script>
{% endblock %}