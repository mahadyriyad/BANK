{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Deposit Money - NeoVault Bank{% endblock %}

{% block dashboard_content %}
<div class="page-header animate-slide-up">
    <h1><i class="fas fa-money-bill-wave me-2"></i>Deposit Money</h1>
    <p class="text-muted">Add funds to your account securely</p>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="operation-card animate-fade-in">
            <h3 class="mb-4">üí∞ Make a Deposit</h3>
            
            <form id="depositForm">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label for="accountSelect" class="form-label">Select Account</label>
                    <select class="form-select" id="accountSelect" required>
                        <option value="">Choose account...</option>
                        {% for account in user_accounts %}
                        <option value="{{ account.id }}" data-balance="{{ account.balance }}">
                            {{ account.get_account_type_display }} - {{ account.account_number }} (Balance: ‡ß≥{{ account.balance|floatformat:2 }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="amount" class="form-label">Amount</label>
                    <div class="input-group">
                        <span class="input-group-text">‡ß≥</span>
                        <input type="number" class="form-control" id="amount" 
                               placeholder="0.00" min="100" step="0.01" required>
                    </div>
                    <div class="form-text">Minimum deposit: ‡ß≥100.00</div>
                </div>
                
                <div class="mb-4">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" rows="3" 
                              placeholder="Add a note for this deposit (optional)"></textarea>
                </div>
                
                <div class="mb-4">
                    <label class="form-label">Deposit Method</label>
                    <div class="deposit-methods">
                        <div class="method-option active" data-method="bank-transfer">
                            <i class="fas fa-university"></i>
                            <span>Bank Transfer</span>
                        </div>
                        <div class="method-option" data-method="debit-card">
                            <i class="fas fa-credit-card"></i>
                            <span>Debit Card</span>
                        </div>
                        <div class="method-option" data-method="mobile-wallet">
                            <i class="fas fa-mobile-alt"></i>
                            <span>Mobile Wallet</span>
                        </div>
                        <div class="method-option" data-method="cash">
                            <i class="fas fa-money-bill"></i>
                            <span>Cash Deposit</span>
                        </div>
                    </div>
                </div>
                
                <!-- Bank Transfer Details -->
                <div class="method-details active" id="bank-transfer-details">
                    <h5 class="mb-3">üè¶ Bank Transfer Instructions</h5>
                    <div class="bank-details">
                        <div class="detail-item">
                            <span>Bank Name:</span>
                            <strong>NeoVault Bank</strong>
                        </div>
                        <div class="detail-item">
                            <span>Account Number:</span>
                            <strong>NV{{ user.id|stringformat:"06d" }}001</strong>
                        </div>
                        <div class="detail-item">
                            <span>Routing Number:</span>
                            <strong>021000021</strong>
                        </div>
                        <div class="detail-item">
                            <span>SWIFT Code:</span>
                            <strong>NVBDUS33</strong>
                        </div>
                        <div class="detail-item">
                            <span>Reference:</span>
                            <strong>DEP{{ user.id }}{{ "now"|date:"Ymd" }}</strong>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Transfers typically take 1-2 business days to process
                    </div>
                </div>
                
                <!-- Debit Card Details -->
                <div class="method-details" id="debit-card-details">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Card Number</label>
                            <input type="text" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Expiry Date</label>
                            <input type="text" class="form-control" placeholder="MM/YY">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">CVV</label>
                            <input type="text" class="form-control" placeholder="123" maxlength="3">
                        </div>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-shield-alt me-2"></i>
                        Your card information is secured with SSL encryption
                    </div>
                </div>
                
                <!-- Mobile Wallet Details -->
                <div class="method-details" id="mobile-wallet-details">
                    <div class="mb-3">
                        <label class="form-label">Select Wallet</label>
                        <select class="form-select">
                            <option value="">Choose wallet...</option>
                            <option value="bkash">bKash</option>
                            <option value="nagad">Nagad</option>
                            <option value="rocket">Rocket</option>
                            <option value="upay">Upay</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Wallet Number</label>
                        <input type="text" class="form-control" placeholder="01XXX-XXXXXX">
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        You will be redirected to your wallet app for payment confirmation
                    </div>
                </div>
                
                <!-- Cash Deposit Details -->
                <div class="method-details" id="cash-details">
                    <div class="mb-3">
                        <label class="form-label">Select Branch</label>
                        <select class="form-select">
                            <option value="">Choose branch...</option>
                            <option value="dhaka">Dhaka Main Branch</option>
                            <option value="chittagong">Chittagong Branch</option>
                            <option value="sylhet">Sylhet Branch</option>
                            <option value="khulna">Khulna Branch</option>
                        </select>
                    </div>
                    <div class="alert alert-success">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Visit the selected branch with cash and your ID card
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-paper-plane me-2"></i>Process Deposit
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Deposit Summary -->
        <div class="summary-card animate-fade-in">
            <h4 class="mb-4">üíµ Deposit Summary</h4>
            
            <div class="summary-item">
                <span>Selected Account:</span>
                <strong id="selectedAccount">-</strong>
            </div>
            
            <div class="summary-item">
                <span>Current Balance:</span>
                <strong id="currentBalance">-</strong>
            </div>
            
            <div class="summary-item">
                <span>Deposit Amount:</span>
                <strong id="depositAmount">‡ß≥0.00</strong>
            </div>
            
            <div class="summary-item">
                <span>Processing Fee:</span>
                <strong id="processingFee">‡ß≥0.00</strong>
            </div>
            
            <div class="summary-item">
                <span>New Balance:</span>
                <strong id="newBalance">-</strong>
            </div>
            
            <hr>
            
            <div class="summary-item total">
                <span>Total to Deposit:</span>
                <strong id="totalAmount">‡ß≥0.00</strong>
            </div>
        </div>
        
        <!-- Quick Tips -->
        <div class="tips-card animate-fade-in">
            <h5><i class="fas fa-lightbulb me-2"></i>üí° Quick Tips</h5>
            <ul class="tips-list">
                <li>Bank transfers take 1-2 business days</li>
                <li>Keep your deposit receipts for reference</li>
                <li>Contact support for large deposits (>‡ß≥50,000)</li>
                <li>Verify account details before transferring</li>
                <li>Mobile wallet deposits are instant</li>
            </ul>
        </div>
        
        <!-- Recent Deposits -->
        <div class="recent-card animate-fade-in">
            <h5>üïê Recent Deposits</h5>
            <div class="recent-list">
                {% for transaction in recent_deposits %}
                <div class="recent-item">
                    <div class="recent-info">
                        <strong>‡ß≥{{ transaction.amount|floatformat:2 }}</strong>
                        <small>{{ transaction.timestamp|date:"M d" }}</small>
                    </div>
                    <span class="status completed">Completed</span>
                </div>
                {% empty %}
                <div class="empty-state-small">
                    <i class="fas fa-history text-muted"></i>
                    <p class="text-muted mb-0">No recent deposits</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 class="mt-4 mb-3">üéâ Deposit Successful!</h3>
                <p class="text-muted mb-4">Your deposit has been processed successfully.</p>
                <div class="deposit-details mb-4">
                    <div class="detail-row">
                        <span>Amount:</span>
                        <strong id="successAmount"></strong>
                    </div>
                    <div class="detail-row">
                        <span>New Balance:</span>
                        <strong id="successBalance"></strong>
                    </div>
                    <div class="detail-row">
                        <span>Reference:</span>
                        <strong id="successReference"></strong>
                    </div>
                    <div class="detail-row">
                        <span>Date & Time:</span>
                        <strong id="successDateTime"></strong>
                    </div>
                </div>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Continue</button>
                    <button type="button" class="btn btn-outline-primary print-receipt" id="printDepositReceipt">
                        <i class="fas fa-print me-2"></i>Print Receipt
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Processing Modal -->
<div class="modal fade" id="processingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="processing-spinner">
                    <i class="fas fa-sync fa-spin"></i>
                </div>
                <h3 class="mt-4 mb-3">Processing Deposit</h3>
                <p class="text-muted mb-4">Please wait while we process your transaction...</p>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const accountSelect = document.getElementById('accountSelect');
    const amountInput = document.getElementById('amount');
    const depositForm = document.getElementById('depositForm');
    const methodOptions = document.querySelectorAll('.method-option');
    
    let currentMethod = 'bank-transfer';
    let processingFee = 0;
    
    // Update summary when account is selected
    accountSelect.addEventListener('change', updateSummary);
    amountInput.addEventListener('input', updateSummary);
    
    // Deposit method selection
    methodOptions.forEach(option => {
        option.addEventListener('click', function() {
            methodOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            
            // Show corresponding method details
            currentMethod = this.getAttribute('data-method');
            document.querySelectorAll('.method-details').forEach(detail => {
                detail.classList.remove('active');
            });
            document.getElementById(`${currentMethod}-details`).classList.add('active');
            
            // Update processing fee based on method
            updateProcessingFee();
            updateSummary();
        });
    });
    
    function updateProcessingFee() {
        switch(currentMethod) {
            case 'bank-transfer':
                processingFee = 0;
                break;
            case 'debit-card':
                processingFee = 10;
                break;
            case 'mobile-wallet':
                processingFee = 5;
                break;
            case 'cash':
                processingFee = 0;
                break;
        }
    }
    
    function updateSummary() {
        const selectedOption = accountSelect.options[accountSelect.selectedIndex];
        const currentBalance = selectedOption ? parseFloat(selectedOption.getAttribute('data-balance')) : 0;
        const depositAmount = parseFloat(amountInput.value) || 0;
        const totalAmount = depositAmount + processingFee;
        
        document.getElementById('selectedAccount').textContent = 
            selectedOption ? selectedOption.text.split('(')[0] : '-';
        document.getElementById('currentBalance').textContent = 
            currentBalance ? `‡ß≥${currentBalance.toFixed(2)}` : '-';
        document.getElementById('depositAmount').textContent = `‡ß≥${depositAmount.toFixed(2)}`;
        document.getElementById('processingFee').textContent = `‡ß≥${processingFee.toFixed(2)}`;
        document.getElementById('totalAmount').textContent = `‡ß≥${totalAmount.toFixed(2)}`;
        
        if (currentBalance) {
            const newBalance = currentBalance + depositAmount;
            document.getElementById('newBalance').textContent = `‡ß≥${newBalance.toFixed(2)}`;
        }
    }
    
    // Form submission
    depositForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const selectedOption = accountSelect.options[accountSelect.selectedIndex];
        const depositAmount = parseFloat(amountInput.value) || 0;
        
        if (!selectedOption || !selectedOption.value) {
            showNotification('Please select an account', 'error');
            return;
        }
        
        if (depositAmount < 100) {
            showNotification('Minimum deposit amount is ‡ß≥100.00', 'error');
            return;
        }
        
        // Show processing modal
        const processingModal = new bootstrap.Modal(document.getElementById('processingModal'));
        processingModal.show();
        
        // Simulate API call
        setTimeout(() => {
            processingModal.hide();
            
            // Show success modal
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            const transactionId = 'DEP' + Date.now();
            
            document.getElementById('successAmount').textContent = `‡ß≥${depositAmount.toFixed(2)}`;
            document.getElementById('successBalance').textContent = `‡ß≥${(parseFloat(selectedOption.getAttribute('data-balance')) + depositAmount).toFixed(2)}`;
            document.getElementById('successReference').textContent = transactionId;
            document.getElementById('successDateTime').textContent = new Date().toLocaleString();
            
            // Update print button
            document.getElementById('printDepositReceipt').setAttribute('data-transaction-id', transactionId);
            document.getElementById('printDepositReceipt').setAttribute('data-amount', depositAmount.toFixed(2));
            
            successModal.show();
            
            // Reset form
            depositForm.reset();
            updateSummary();
        }, 3000);
    });
    
    // Print receipt functionality
    document.getElementById('printDepositReceipt').addEventListener('click', function() {
        const transactionData = {
            id: this.getAttribute('data-transaction-id'),
            type: 'Deposit',
            amount: this.getAttribute('data-amount'),
            date: new Date().toLocaleString(),
            fromAccount: 'External Source',
            toAccount: document.getElementById('selectedAccount').textContent,
            description: document.getElementById('description').value || 'Funds Deposit',
            method: currentMethod,
            fee: processingFee
        };
        
        if (window.PrintUtils) {
            window.PrintUtils.printTransactionReceipt(transactionData);
        } else {
            showNotification('Print functionality is not available', 'warning');
        }
    });
    
    // Format card number input
    const cardNumberInput = document.querySelector('input[placeholder="1234 5678 9012 3456"]');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            let matches = value.match(/\d{4,16}/g);
            let match = matches && matches[0] || '';
            let parts = [];
            
            for (let i=0; i<match.length; i+=4) {
                parts.push(match.substring(i, i+4));
            }
            
            if (parts.length) {
                e.target.value = parts.join(' ');
            } else {
                e.target.value = value;
            }
        });
    }
    
    // Initialize
    updateProcessingFee();
    updateSummary();
});
</script>
{% endblock %}