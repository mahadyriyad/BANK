{% extends 'base.html' %}
{% load static %}

{% block title %}Profile Settings - NeoVault Bank{% endblock %}

{% block content %}
<div class="dashboard-container">
    {% include 'partials/dashboard_sidebar.html' %}
    
    <div class="dashboard-main">
        <div class="page-header">
            <h1><i class="fas fa-user-cog me-2"></i>Profile Settings</h1>
            <p class="text-muted">Manage your account information and preferences</p>
        </div>

        <div class="row">
            <div class="col-lg-4">
                <!-- Profile Card -->
                <div class="profile-card text-center">
                    <div class="profile-avatar">
                        {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}" id="profileImage">
                        {% else %}
                        <div class="avatar-placeholder" id="avatarPlaceholder">
                            <i class="fas fa-user"></i>
                        </div>
                        {% endif %}
                        <div class="avatar-overlay">
                            <label for="profilePictureInput" class="avatar-upload-btn">
                                <i class="fas fa-camera"></i>
                            </label>
                            <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    
                    <h3 class="mt-3">{{ user.get_full_name|default:user.username }}</h3>
                    <p class="text-muted">{{ user.email }}</p>
                    
                    <div class="profile-stats">
                        <div class="stat-item">
                            <strong>{{ accounts.count }}</strong>
                            <span>Accounts</span>
                        </div>
                        <div class="stat-item">
                            <strong>{{ user.date_joined|date:"Y" }}</strong>
                            <span>Member Since</span>
                        </div>
                        <div class="stat-item">
                            <strong>{{ verification_level }}</strong>
                            <span>Verification</span>
                        </div>
                    </div>
                </div>
                
                <!-- Security Status -->
                <div class="summary-card mt-4">
                    <h5 class="mb-3">Security Status</h5>
                    <div class="security-items">
                        <div class="security-item completed">
                            <i class="fas fa-check-circle"></i>
                            <span>Email Verified</span>
                        </div>
                        <div class="security-item completed">
                            <i class="fas fa-check-circle"></i>
                            <span>Phone Verified</span>
                        </div>
                        <div class="security-item {% if user.has_2fa %}completed{% else %}pending{% endif %}">
                            <i class="fas {% if user.has_2fa %}fa-check-circle{% else %}fa-times-circle{% endif %}"></i>
                            <span>2FA Enabled</span>
                        </div>
                        <div class="security-item completed">
                            <i class="fas fa-check-circle"></i>
                            <span>Strong Password</span>
                        </div>
                    </div>
                    <button class="btn btn-outline-primary w-100 mt-3" id="securitySettingsBtn">
                        <i class="fas fa-shield-alt me-2"></i>Security Settings
                    </button>
                </div>
            </div>
            
            <div class="col-lg-8">
                <!-- Personal Information -->
                <div class="operation-card">
                    <h3 class="mb-4">Personal Information</h3>
                    
                    <form id="personalInfoForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="firstName" 
                                       value="{{ user.first_name }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="lastName" 
                                       value="{{ user.last_name }}" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="email" 
                                       value="{{ user.email }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phone" 
                                       value="{{ user.phone }}">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dateOfBirth" class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="dateOfBirth" 
                                   value="{{ user.date_of_birth|date:'Y-m-d' }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <textarea class="form-control" id="address" rows="3">{{ user.address }}</textarea>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" id="resetPersonalInfo">
                                <i class="fas fa-undo me-2"></i>Reset
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Save Changes
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Account Preferences -->
                <div class="operation-card mt-4">
                    <h3 class="mb-4">Account Preferences</h3>
                    
                    <div class="preferences-list">
                        <div class="preference-item">
                            <div class="preference-info">
                                <h6>Email Notifications</h6>
                                <p class="text-muted mb-0">Receive email alerts for transactions and security updates</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                            </div>
                        </div>
                        
                        <div class="preference-item">
                            <div class="preference-info">
                                <h6>SMS Notifications</h6>
                                <p class="text-muted mb-0">Get text message alerts for important account activities</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="smsNotifications">
                            </div>
                        </div>
                        
                        <div class="preference-item">
                            <div class="preference-info">
                                <h6>Monthly Statements</h6>
                                <p class="text-muted mb-0">Receive monthly account statements via email</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="monthlyStatements" checked>
                            </div>
                        </div>
                        
                        <div class="preference-item">
                            <div class="preference-info">
                                <h6>Marketing Communications</h6>
                                <p class="text-muted mb-0">Receive offers and updates about new banking products</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="marketingEmails">
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary mt-3" id="savePreferences">
                        <i class="fas fa-save me-2"></i>Save Preferences
                    </button>
                </div>

                <!-- Security Settings -->
                <div class="operation-card mt-4">
                    <h3 class="mb-4">Security Settings</h3>
                    
                    <div class="security-settings">
                        <div class="security-setting">
                            <div class="setting-info">
                                <h6>Two-Factor Authentication</h6>
                                <p class="text-muted mb-0">Add an extra layer of security to your account</p>
                            </div>
                            <button class="btn btn-outline-primary" id="enable2FA">
                                {% if user.has_2fa %}
                                <i class="fas fa-lock me-2"></i>Manage 2FA
                                {% else %}
                                <i class="fas fa-lock-open me-2"></i>Enable 2FA
                                {% endif %}
                            </button>
                        </div>
                        
                        <div class="security-setting">
                            <div class="setting-info">
                                <h6>Change Password</h6>
                                <p class="text-muted mb-0">Update your account password regularly</p>
                            </div>
                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                <i class="fas fa-key me-2"></i>Change Password
                            </button>
                        </div>
                        
                        <div class="security-setting">
                            <div class="setting-info">
                                <h6>Login Activity</h6>
                                <p class="text-muted mb-0">Review recent login attempts and sessions</p>
                            </div>
                            <button class="btn btn-outline-primary" id="viewLoginActivity">
                                <i class="fas fa-history me-2"></i>View Activity
                            </button>
                        </div>
                        
                        <div class="security-setting">
                            <div class="setting-info">
                                <h6>Connected Devices</h6>
                                <p class="text-muted mb-0">Manage devices that can access your account</p>
                            </div>
                            <button class="btn btn-outline-primary" id="manageDevices">
                                <i class="fas fa-laptop me-2"></i>Manage Devices
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" required>
                        <div class="form-text">Password must be at least 8 characters long</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                    </div>
                    
                    <div class="password-strength mb-3">
                        <div class="strength-bar">
                            <div class="strength-level" id="passwordStrength"></div>
                        </div>
                        <small class="text-muted" id="passwordFeedback"></small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="changePasswordForm" class="btn btn-primary">Update Password</button>
            </div>
        </div>
    </div>
</div>

<!-- 2FA Setup Modal -->
<div class="modal fade" id="twoFAModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Two-Factor Authentication</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-shield-alt fa-3x text-primary"></i>
                </div>
                
                <h5>Enable 2FA for Extra Security</h5>
                <p class="text-muted mb-4">
                    Protect your account with an additional security layer. 
                    You'll need to enter a verification code from your authenticator app when signing in.
                </p>
                
                <div class="qr-code mb-4">
                    <!-- QR Code would be generated here -->
                    <div class="qr-placeholder">
                        <i class="fas fa-qrcode fa-4x text-muted"></i>
                        <p class="mt-2 text-muted">QR Code for Authenticator App</p>
                    </div>
                </div>
                
                <div class="setup-key mb-4">
                    <label class="form-label">Setup Key</label>
                    <div class="input-group">
                        <input type="text" class="form-control" value="NVBA-2FA-{{ user.id }}-SECRET" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="copySetupKey">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="verification-code mb-4">
                    <label for="verificationCode" class="form-label">Enter Verification Code</label>
                    <input type="text" class="form-control text-center" id="verificationCode" 
                           placeholder="000000" maxlength="6">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="verify2FA">Verify & Enable</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .profile-card {
        background: var(--card-bg);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 5px 15px var(--shadow-color);
    }
    
    .profile-avatar {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto;
        border-radius: 50%;
        overflow: hidden;
        border: 4px solid var(--primary-color);
    }
    
    .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .avatar-placeholder {
        width: 100%;
        height: 100%;
        background: var(--light-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: var(--primary-color);
    }
    
    .avatar-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .profile-avatar:hover .avatar-overlay {
        opacity: 1;
    }
    
    .avatar-upload-btn {
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 10px;
        border-radius: 50%;
        background: var(--primary-color);
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .profile-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-item strong {
        display: block;
        font-size: 1.2rem;
        color: var(--primary-color);
    }
    
    .stat-item span {
        font-size: 0.8rem;
        color: var(--text-color);
        opacity: 0.7;
    }
    
    .security-items {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .security-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        border-radius: 8px;
        background: var(--light-color);
    }
    
    .security-item.completed {
        border-left: 3px solid var(--success-color);
    }
    
    .security-item.pending {
        border-left: 3px solid var(--warning-color);
    }
    
    .security-item i {
        font-size: 1.1rem;
    }
    
    .security-item.completed i {
        color: var(--success-color);
    }
    
    .security-item.pending i {
        color: var(--warning-color);
    }
    
    .preferences-list, .security-settings {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .preference-item, .security-setting {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: var(--light-color);
        border-radius: 10px;
    }
    
    .preference-info h6, .setting-info h6 {
        margin-bottom: 5px;
        color: var(--primary-color);
    }
    
    .form-switch .form-check-input {
        width: 3em;
        height: 1.5em;
    }
    
    .password-strength {
        margin-top: 10px;
    }
    
    .strength-bar {
        height: 5px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 5px;
    }
    
    .strength-level {
        height: 100%;
        width: 0%;
        transition: all 0.3s ease;
        border-radius: 3px;
    }
    
    .qr-placeholder {
        padding: 30px;
        background: var(--light-color);
        border-radius: 10px;
        border: 2px dashed #dee2e6;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Profile picture upload
        const profilePictureInput = document.getElementById('profilePictureInput');
        const profileImage = document.getElementById('profileImage');
        const avatarPlaceholder = document.getElementById('avatarPlaceholder');
        
        profilePictureInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (profileImage) {
                        profileImage.src = e.target.result;
                    } else {
                        avatarPlaceholder.innerHTML = `<img src="${e.target.result}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">`;
                    }
                };
                reader.readAsDataURL(file);
                showNotification('Profile picture updated successfully!', 'success');
            }
        });
        
        // Personal information form
        const personalInfoForm = document.getElementById('personalInfoForm');
        const resetPersonalInfoBtn = document.getElementById('resetPersonalInfo');
        
        personalInfoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div> Saving...';
            submitBtn.disabled = true;
            
            setTimeout(() => {
                showNotification('Personal information updated successfully!', 'success');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }, 1500);
        });
        
        resetPersonalInfoBtn.addEventListener('click', function() {
            personalInfoForm.reset();
        });
        
        // Save preferences
        document.getElementById('savePreferences').addEventListener('click', function() {
            const originalText = this.innerHTML;
            this.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div> Saving...';
            this.disabled = true;
            
            setTimeout(() => {
                showNotification('Preferences saved successfully!', 'success');
                this.innerHTML = originalText;
                this.disabled = false;
            }, 1000);
        });
        
        // 2FA setup
        const enable2FABtn = document.getElementById('enable2FA');
        const twoFAModal = new bootstrap.Modal(document.getElementById('twoFAModal'));
        const copySetupKeyBtn = document.getElementById('copySetupKey');
        const verify2FABtn = document.getElementById('verify2FA');
        
        enable2FABtn.addEventListener('click', function() {
            twoFAModal.show();
        });
        
        copySetupKeyBtn.addEventListener('click', function() {
            const setupKey = this.closest('.input-group').querySelector('input');
            setupKey.select();
            document.execCommand('copy');
            showNotification('Setup key copied to clipboard!', 'success');
        });
        
        verify2FABtn.addEventListener('click', function() {
            const originalText = this.innerHTML;
            this.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div> Verifying...';
            this.disabled = true;
            
            setTimeout(() => {
                showNotification('Two-factor authentication enabled successfully!', 'success');
                twoFAModal.hide();
                this.innerHTML = originalText;
                this.disabled = false;
                enable2FABtn.innerHTML = '<i class="fas fa-lock me-2"></i>Manage 2FA';
            }, 1500);
        });
        
        // Change password form
        const changePasswordForm = document.getElementById('changePasswordForm');
        const newPasswordInput = document.getElementById('newPassword');
        const passwordStrength = document.getElementById('passwordStrength');
        const passwordFeedback = document.getElementById('passwordFeedback');
        
        newPasswordInput.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            let feedback = '';
            let color = '#dc3545';
            
            if (password.length >= 8) strength += 25;
            if (/[A-Z]/.test(password)) strength += 25;
            if (/[0-9]/.test(password)) strength += 25;
            if (/[^A-Za-z0-9]/.test(password)) strength += 25;
            
            if (strength < 25) {
                feedback = 'Very Weak';
                color = '#dc3545';
            } else if (strength < 50) {
                feedback = 'Weak';
                color = '#fd7e14';
            } else if (strength < 75) {
                feedback = 'Good';
                color = '#ffc107';
            } else {
                feedback = 'Strong';
                color = '#28a745';
            }
            
            passwordStrength.style.width = strength + '%';
            passwordStrength.style.background = color;
            passwordFeedback.textContent = feedback;
            passwordFeedback.style.color = color;
        });
        
        changePasswordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showNotification('Passwords do not match!', 'danger');
                return;
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div> Updating...';
            submitBtn.disabled = true;
            
            setTimeout(() => {
                showNotification('Password updated successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                this.reset();
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }, 1500);
        });
        
        // Security settings buttons
        document.getElementById('securitySettingsBtn').addEventListener('click', function() {
            document.querySelector('.security-settings').scrollIntoView({ behavior: 'smooth' });
        });
        
        document.getElementById('viewLoginActivity').addEventListener('click', function() {
            showNotification('Login activity feature would be implemented here', 'info');
        });
        
        document.getElementById('manageDevices').addEventListener('click', function() {
            showNotification('Device management feature would be implemented here', 'info');
        });
    });
</script>
{% endblock %}