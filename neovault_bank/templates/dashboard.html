{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Dashboard - NeoVault Bank{% endblock %}

{% block dashboard_content %}
<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" id="mobileMenuToggle" style="display: none;">
    <i class="fas fa-bars"></i>
</button>

<!-- Dashboard Header -->
<div class="dashboard-header animate-slide-up">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="animate-bounce-in">Welcome back, {{ user.first_name|default:user.username }}! ðŸ‘‹</h1>
            <p class="text-muted">Here's your financial overview for {{ current_date }}</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="balance-display">
                <span class="balance-label">Total Balance</span>
                <h2 class="total-balance" id="totalBalance" data-balance="à§³{{ total_balance|floatformat:2 }}">
                    à§³{{ total_balance|floatformat:2 }}
                </h2>
                <button class="btn btn-sm btn-outline-secondary balance-toggle" id="balanceToggle">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="dashboard-stats animate-fade-in">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="stat-info">
                <h3 id="accountsCount">{{ accounts.count }}</h3>
                <p>Accounts</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-credit-card"></i>
            </div>
            <div class="stat-info">
                <h3 id="cardsCount">{{ credit_cards.count }}</h3>
                <p>Credit Cards</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div class="stat-info">
                <h3 id="billsCount">{{ bills.count }}</h3>
                <p>Pending Bills</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-bullseye"></i>
            </div>
            <div class="stat-info">
                <h3 id="goalsCount">{{ savings_goals.count }}</h3>
                <p>Savings Goals</p>
            </div>
        </div>
    </div>
</div>

<!-- Add this to dashboard.html for testing -->
<button onclick="testWithdraw()" class="btn btn-warning">Test Withdraw</button>

<!-- Quick Actions -->
<div class="quick-actions animate-slide-up">
    <h2>ðŸš€ Quick Actions</h2>
    <div class="action-grid">
        <a href="{% url 'deposit' %}" class="action-card quick-action" data-action="deposit">
            <div class="action-icon">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <span>Deposit</span>
            <div class="action-hover">
                <small>Add money to your account</small>
            </div>
        </a>
        <a href="{% url 'withdraw' %}" class="action-card quick-action" data-action="withdraw">
            <div class="action-icon">
                <i class="fas fa-hand-holding-usd"></i>
            </div>
            <span>Withdraw</span>
            <div class="action-hover">
                <small>Withdraw money from account</small>
            </div>
        </a>
        <a href="{% url 'transfer' %}" class="action-card quick-action" data-action="transfer">
            <div class="action-icon">
                <i class="fas fa-exchange-alt"></i>
            </div>
            <span>Transfer</span>
            <div class="action-hover">
                <small>Transfer between accounts</small>
            </div>
        </a>
        <a href="{% url 'bills' %}" class="action-card quick-action" data-action="bills">
            <div class="action-icon">
                <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <span>Pay Bills</span>
            <div class="action-hover">
                <small>Pay your utility bills</small>
            </div>
        </a>
        <a href="{% url 'credit_cards' %}" class="action-card quick-action" data-action="credit-cards">
            <div class="action-icon">
                <i class="fas fa-credit-card"></i>
            </div>
            <span>Credit Cards</span>
            <div class="action-hover">
                <small>Manage credit cards</small>
            </div>
        </a>
        <a href="{% url 'savings_goals' %}" class="action-card quick-action" data-action="savings-goals">
            <div class="action-icon">
                <i class="fas fa-bullseye"></i>
            </div>
            <span>Savings Goals</span>
            <div class="action-hover">
                <small>Track savings goals</small>
            </div>
        </a>
    </div>
</div>

<div class="row mt-4">
    <!-- Accounts Overview -->
    <div class="col-lg-6">
        <div class="accounts-section animate-fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>ðŸ’¼ Your Accounts</h2>
                <a href="#" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-plus me-1"></i>Open New
                </a>
            </div>
            <div class="accounts-grid">
                {% for account in accounts %}
                <div class="account-card" data-account-id="{{ account.id }}">
                    <div class="account-header">
                        <h4>{{ account.get_account_type_display }}</h4>
                        <span class="account-status active">Active</span>
                    </div>
                    <p class="account-number">{{ account.account_number }}</p>
                    <p class="balance">à§³<span class="account-balance" data-balance="à§³{{ account.balance|floatformat:2 }}">
                        {{ account.balance|floatformat:2 }}
                    </span></p>
                    <div class="account-footer">
                        <small class="text-muted">Last updated: {{ account.updated_at|date:"M d, Y" }}</small>
                        <button class="btn btn-sm btn-outline-primary view-statement" data-account-id="{{ account.id }}">
                            Statement
                        </button>
                    </div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <i class="fas fa-wallet fa-3x text-muted mb-3"></i>
                    <h4>No Accounts Found</h4>
                    <p class="text-muted">You don't have any active accounts yet.</p>
                    <a href="#" class="btn btn-primary">Open Your First Account</a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="col-lg-6">
        <div class="transactions-section animate-fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>ðŸ“Š Recent Transactions</h2>
                <div class="transaction-filters">
                    <button class="btn btn-outline-secondary btn-sm transaction-filter active" data-filter="all">All</button>
                    <button class="btn btn-outline-secondary btn-sm transaction-filter" data-filter="deposit">Income</button>
                    <button class="btn btn-outline-secondary btn-sm transaction-filter" data-filter="withdrawal">Expense</button>
                </div>
            </div>
            <div class="transactions-list" id="transactionsList">
                {% for transaction in transactions %}
                <div class="transaction-item {% if transaction.transaction_type == 'withdrawal' or transaction.transaction_type == 'transfer_out' or transaction.transaction_type == 'payment' %}withdrawal{% else %}deposit{% endif %}" 
                     data-category="{{ transaction.category }}"
                     data-transaction-id="{{ transaction.id }}">
                    <div class="transaction-icon">
                        <i class="fas fa-{{ transaction.get_icon }}"></i>
                    </div>
                    <div class="transaction-info">
                        <h5>{{ transaction.get_transaction_type_display }}</h5>
                        <p class="text-muted mb-0">{{ transaction.description }}</p>
                        <small class="text-muted">{{ transaction.timestamp|date:"M d, Y H:i" }}</small>
                    </div>
                    <div class="transaction-amount">
                        {% if transaction.transaction_type == 'deposit' or transaction.transaction_type == 'transfer_in' %}+{% else %}-{% endif %}à§³{{ transaction.amount|floatformat:2 }}
                    </div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
                    <h4>No Transactions Yet</h4>
                    <p class="text-muted">Your transaction history will appear here.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Additional Dashboard Sections -->
<div class="row mt-4">
    <!-- Credit Cards -->
    <div class="col-lg-6">
        <div class="accounts-section animate-fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>ðŸ’³ Credit Cards</h2>
                <a href="{% url 'apply_credit_card' %}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-plus me-1"></i>Apply New
                </a>
            </div>
            <div class="accounts-grid">
                {% for card in credit_cards %}
                <div class="account-card credit-card" data-card-id="{{ card.id }}">
                    <div class="card-header">
                        <h4>{{ card.get_card_type_display }}</h4>
                        <span class="badge bg-success">Active</span>
                        {% if card.is_primary %}
                        <span class="badge bg-primary">Primary</span>
                        {% endif %}
                    </div>
                    <p class="account-number">**** **** **** {{ card.card_number|slice:"-4:" }}</p>
                    <p class="balance">à§³<span class="available-credit">{{ card.available_credit|floatformat:2 }}</span></p>
                    <div class="card-details">
                        <small class="text-muted">Credit Limit: à§³{{ card.credit_limit|floatformat:2 }}</small>
                        <small class="text-muted">Due Date: {{ card.next_payment_due|date:"M d" }}</small>
                    </div>
                    <div class="progress mb-2">
                        <div class="progress-bar {% if card.utilization_percentage > 80 %}bg-danger{% elif card.utilization_percentage > 50 %}bg-warning{% else %}bg-success{% endif %}" 
                             style="width: {{ card.utilization_percentage }}%">
                            {{ card.utilization_percentage|floatformat:0 }}%
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-outline-primary card-lock-btn {% if card.is_locked %}locked{% endif %}" 
                                data-card-id="{{ card.id }}">
                            <i class="fas {% if card.is_locked %}fa-lock-open{% else %}fa-lock{% endif %}"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary view-statement">
                            Statement
                        </button>
                    </div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                    <h4>No Credit Cards</h4>
                    <p class="text-muted">You don't have any credit cards yet.</p>
                    <a href="{% url 'apply_credit_card' %}" class="btn btn-primary">Apply for Card</a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Savings Goals -->
    <div class="col-lg-6">
        <div class="accounts-section animate-fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>ðŸŽ¯ Savings Goals</h2>
                <a href="{% url 'savings_goals' %}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-plus me-1"></i>New Goal
                </a>
            </div>
            <div class="accounts-grid">
                {% for goal in savings_goals %}
                <div class="account-card savings-goal" data-goal-id="{{ goal.id }}">
                    <div class="goal-header">
                        <h4>{{ goal.name }}</h4>
                        <span class="goal-category {{ goal.category }}">{{ goal.get_category_display }}</span>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar" style="width: {{ goal.progress_percentage }}%">
                            <span class="progress-percentage">{{ goal.progress_percentage|floatformat:0 }}%</span>
                        </div>
                    </div>
                    <p class="balance">
                        à§³<span class="current-amount">{{ goal.current_amount|floatformat:2 }}</span> 
                        <span class="text-muted">/ à§³{{ goal.target_amount|floatformat:2 }}</span>
                    </p>
                    <div class="goal-details">
                        <small class="text-muted">Target: {{ goal.target_date|date:"M d, Y" }}</small>
                        <small class="text-muted">{{ goal.time_left }} left</small>
                    </div>
                    <button class="btn btn-sm btn-success add-funds-btn" data-goal-id="{{ goal.id }}">
                        <i class="fas fa-plus me-1"></i>Add Funds
                    </button>
                </div>
                {% empty %}
                <div class="empty-state">
                    <i class="fas fa-bullseye fa-3x text-muted mb-3"></i>
                    <h4>No Savings Goals</h4>
                    <p class="text-muted">Start saving for your dreams today!</p>
                    <a href="{% url 'savings_goals' %}" class="btn btn-primary">Set a Goal</a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mt-4">
    <div class="col-lg-8">
        <div class="operation-card">
            <h3 class="mb-4">ðŸ“ˆ Financial Overview</h3>
            <div class="chart-container">
                <canvas id="balanceChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="operation-card">
            <h3 class="mb-4">ðŸ’° Spending by Category</h3>
            <div class="chart-container">
                <canvas id="spendingChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Add Funds Modal -->
<div class="modal fade" id="addFundsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ðŸ’° Add Funds to Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addFundsForm">
                    <input type="hidden" id="modalGoalId" name="goal_id">
                    <div class="mb-3">
                        <label class="form-label">Goal</label>
                        <input type="text" class="form-control" id="modalGoalName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Current Progress</label>
                        <div class="progress mb-2">
                            <div class="progress-bar" id="modalProgressBar"></div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small id="modalCurrentAmount"></small>
                            <small id="modalTargetAmount"></small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="fundAmount" class="form-label">Amount to Add</label>
                        <div class="input-group">
                            <span class="input-group-text">à§³</span>
                            <input type="number" class="form-control" id="fundAmount" placeholder="0.00" min="1" step="0.01" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="fundSource" class="form-label">From Account</label>
                        <select class="form-select" id="fundSource" required>
                            <option value="">Select account...</option>
                            {% for account in accounts %}
                            <option value="{{ account.id }}">{{ account.account_number }} - à§³{{ account.balance|floatformat:2 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addFundsForm" class="btn btn-success">Add Funds</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 class="mt-4 mb-3">ðŸŽ‰ Transaction Successful!</h3>
                <p class="text-muted mb-4" id="successMessage">Your transaction has been processed successfully.</p>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Continue</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Refresh Data Button -->
<div class="position-fixed bottom-0 end-0 p-3">
    <button class="btn btn-primary btn-lg rounded-pill shadow" id="refreshData" title="Refresh Dashboard">
        <i class="fas fa-sync-alt"></i>
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script>

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard initialized');
    
    // Auto-refresh dashboard data every 30 seconds
    setInterval(fetchDashboardData, 30000);
    
    // Manual refresh button
    const refreshBtn = document.getElementById('refreshData');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            fetchDashboardData();
            showNotification('Dashboard data refreshed', 'success');
        });
    }
});

// Global function to show notifications
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Make functions available globally
window.showNotification = showNotification;
window.fetchDashboardData = fetchDashboardData;
</script>
{% endblock %}